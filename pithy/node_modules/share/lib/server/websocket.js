// Generated by CoffeeScript 1.6.2
var EventEmitter, WebSocketServer, sessionHandler, wrapSession;

EventEmitter = require('events').EventEmitter;

WebSocketServer = require('ws').Server;

sessionHandler = require('./session').handler;

wrapSession = function(conn) {
  var wrapper;

  wrapper = new EventEmitter;
  wrapper.abort = function() {
    return conn.close();
  };
  wrapper.stop = function() {
    return conn.close();
  };
  wrapper.send = function(response) {
    if (wrapper.ready()) {
      return conn.send(JSON.stringify(response));
    }
  };
  wrapper.ready = function() {
    return conn.readyState === 1;
  };
  conn.on('message', function(data) {
    return wrapper.emit('message', JSON.parse(data));
  });
  wrapper.headers = conn.upgradeReq.headers;
  wrapper.address = conn._socket.server._connectionKey != null;
  return wrapper;
};

exports.attach = function(server, createAgent, options) {
  var wss;

  options.prefix || (options.prefix = '/websocket');
  wss = new WebSocketServer({
    server: server,
    path: options.prefix
  });
  return wss.on('connection', function(conn) {
    return sessionHandler(wrapSession(conn), createAgent);
  });
};
