// Generated by CoffeeScript 1.6.2
var Model, attach, browserChannel, connect, create, createDb, createModel, http, rest, sockjs, websocket;

connect = require('connect');

http = require('http');

Model = require('./model');

createDb = require('./db');

rest = require('./rest');

browserChannel = require('./browserchannel');

sockjs = require('./sockjs');

websocket = require('./websocket');

module.exports = create = function(options, model) {
  if (model == null) {
    model = createModel(options);
  }
  return attach(connect(), options, model);
};

create.createModel = createModel = function(options) {
  var db, dbOptions;

  dbOptions = options != null ? options.db : void 0;
  db = createDb(dbOptions);
  return new Model(db, options);
};

create.attach = attach = function(server, options, model) {
  var createAgent, _ref;

  if (model == null) {
    model = createModel(options);
  }
  if (options == null) {
    options = {};
  }
  if ((_ref = options.staticpath) == null) {
    options.staticpath = '/share';
  }
  server.model = model;
  server.on('close', function() {
    return model.closeDb();
  });
  if (options.staticpath !== null) {
    server.use(options.staticpath, connect["static"]("" + __dirname + "/../../webclient"));
  }
  createAgent = require('./useragent')(model, options);
  if (options.rest !== null) {
    server.use(rest(createAgent, options.rest || {}));
  }
  if (options.browserChannel !== null) {
    browserChannel.attach(server, createAgent, options.browserChannel || {});
  }
  if (!(server instanceof http.Server)) {
    server = http.createServer(server);
  }
  if (options.sockjs != null) {
    sockjs.attach(server, createAgent, options.sockjs || {});
  }
  if (options.websocket != null) {
    websocket.attach(server, createAgent, options.websocket || {});
  }
  return server;
};
