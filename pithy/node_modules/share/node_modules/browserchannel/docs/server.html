<!DOCTYPE html>  <html> <head>   <title>server.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               server.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h1>A BrowserChannel server.</h1>

<ul>
<li>Its still pretty young, so there's probably bugs lurking around and the API
will still change quickly.</li>
<li>Its missing integration tests</li>
</ul>

<p>It works in all the browsers I've tried.</p>

<p>I've written this using the literate programming style to try it out. So, thats why
there's a million comments everywhere.</p>

<p>The server is implemented as connect middleware. Its intended to be used like this:</p>

<p><code>
server = connect(
  browserChannel (client) -&gt; client.send 'hi'
)
</code></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Dependancies, helper methods and constant data</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p><code>parse</code> helps us decode URLs in requests</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span><span class="nx">parse</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;url&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p><code>querystring</code> will help decode the URL-encoded forward channel data</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">querystring = </span><span class="nx">require</span> <span class="s1">&#39;querystring&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p><code>fs</code> is used to read &amp; serve the client library</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">fs = </span><span class="nx">require</span> <span class="s1">&#39;fs&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Client sessions are `EventEmitters</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span><span class="nx">EventEmitter</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;events&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Client session Ids are generated using <code>node-hat</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">hat = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;hat&#39;</span><span class="p">).</span><span class="nx">rack</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">36</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p><code>randomInt(n)</code> generates and returns a random int smaller than n (0 &lt;= k &lt; n)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">randomInt = </span><span class="nf">(n) -&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">n</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p><code>randomArrayElement(array)</code> Selects and returns a random element from <em>array</em></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">randomArrayElement = </span><span class="nf">(array) -&gt;</span> <span class="nx">array</span><span class="p">[</span><span class="nx">randomInt</span><span class="p">(</span><span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">)]</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>For testing we'll override <code>setInterval</code>, etc with special testing stub versions (so
we don't have to actually wait for actual <em>time</em>. To do that, we need local variable
versions (I don't want to edit the global versions). ... and they'll just point to the
normal versions anyway.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span><span class="nx">setInterval</span><span class="p">,</span> <span class="nx">clearInterval</span><span class="p">,</span> <span class="nx">setTimeout</span><span class="p">,</span> <span class="nx">clearTimeout</span><span class="p">,</span> <span class="nb">Date</span><span class="p">}</span> <span class="o">=</span> <span class="nx">global</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>The module is configurable</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">defaultOptions =</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>An optional array of host prefixes. Each browserchannel client will randomly pick
from the list of host prefixes when it connects. This reduces the impact of per-host
connection limits.</p>

<p>All host prefixes should point to the same server. Ie, if your server's hostname
is <em>example.com</em> and your hostPrefixes contains ['a', 'b', 'c'],
a.example.com, b.example.com and c.example.com should all point to the same host
as example.com.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">hostPrefixes: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>You can specify the base URL which browserchannel connects to. Change this if you want
to scope browserchannel in part of your app, or if you want /channel to mean something
else, or whatever.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">base: </span><span class="s1">&#39;/channel&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>We'll send keepalives every so often to make sure the http connection isn't closed by
eagar clients. The standard timeout is 30 seconds, so we'll default to sending them
every 20 seconds or so.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">keepAliveInterval: </span><span class="mi">20</span> <span class="o">*</span> <span class="mi">1000</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>After awhile (30 seconds or so) of not having a backchannel connected, we'll evict the
session completely. This will happen whenever a user closes their browser.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">sessionTimeoutInterval: </span><span class="mi">30</span> <span class="o">*</span> <span class="mi">1000</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>All server responses set some standard HTTP headers.
To be honest, I don't know how many of these are necessary. I just copied
them from google.</p>

<p>The nocache headers in particular seem unnecessary since each client
request includes a randomized <code>zx=junk</code> query parameter.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">standardHeaders =</span>
  <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/plain&#39;</span>
  <span class="s1">&#39;Cache-Control&#39;</span><span class="o">:</span> <span class="s1">&#39;no-cache, no-store, max-age=0, must-revalidate&#39;</span>
  <span class="s1">&#39;Pragma&#39;</span><span class="o">:</span> <span class="s1">&#39;no-cache&#39;</span>
  <span class="s1">&#39;Expires&#39;</span><span class="o">:</span> <span class="s1">&#39;Fri, 01 Jan 1990 00:00:00 GMT&#39;</span>
  <span class="s1">&#39;X-Content-Type-Options&#39;</span><span class="o">:</span> <span class="s1">&#39;nosniff&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Gmail also sends this, though I'm not really sure what it does...
 'X-Xss-Protection': '1; mode=block'</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>The one exception to that is requests destined for iframes. They need to
have content-type: text/html set for IE to process the juicy JS inside.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">ieHeaders = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">create</span> <span class="nx">standardHeaders</span>
<span class="nx">ieHeaders</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;text/html&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Google's browserchannel server adds some junk after the first message data is sent. I
assume this stops some whole-page buffering in IE. I assume the data used is noise so it
doesn't compress.</p>

<p>I don't really know why google does this. I'm assuming there's a good reason to it though.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">ieJunk = </span><span class="s2">&quot;7cca69475363026330a0d99468e88d23ce95e222591126443015f5f462d9a177186c8701fb45a6ffe</span>
<span class="s2">e0daf1a178fc0f58cd309308fba7e6f011ac38c9cdd4580760f1d4560a84d5ca0355ecbbed2ab715a3350fe0c47</span>
<span class="s2">9050640bd0e77acec90c58c4d3dd0f5cf8d4510e68c8b12e087bd88cad349aafd2ab16b07b0b1b8276091217a44</span>
<span class="s2">a9fe92fedacffff48092ee693af\n&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>If the user is using IE, instead of using XHR backchannel loaded using
a forever iframe. When data is sent, it is wrapped in <script></script> tags
which call functions in the browserchannel library.</p>

<p>This method wraps the normal <code>.writeHead()</code>, <code>.write()</code> and <code>.end()</code> methods by
special versions which produce output based on the request's type.</p>

<p>This <strong>is not used</strong> for:</p>

<ul>
<li>The first channel test</li>
<li>The first <em>bind</em> connection a client makes. The server sends arrays there, but the
connection is a POST and it returns immediately. So that request happens using XHR/Trident
like regular forward channel requests.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">messagingMethods = </span><span class="nf">(query, res) -&gt;</span>
  <span class="nv">type = </span><span class="nx">query</span><span class="p">.</span><span class="nx">TYPE</span>
  <span class="k">if</span> <span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span>
    <span class="nv">junkSent = </span><span class="kc">false</span>

    <span class="nv">methods =</span>
      <span class="nv">writeHead: </span><span class="o">-&gt;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;OK&#39;</span><span class="p">,</span> <span class="nx">ieHeaders</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">write</span> <span class="s1">&#39;&lt;html&gt;&lt;body&gt;&#39;</span>

        <span class="nv">domain = </span><span class="nx">query</span><span class="p">.</span><span class="nx">DOMAIN</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>If the iframe is making the request using a secondary domain, I think we need
to set the <code>domain</code> to the original domain so that we can call the response methods.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">domain</span> <span class="o">and</span> <span class="nx">domain</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Make sure the domain doesn't contain anything by naughty by <code>JSON.stringify()</code>-ing
it before passing it to the client. There are XSS vulnerabilities otherwise.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">res</span><span class="p">.</span><span class="nx">write</span> <span class="s2">&quot;&lt;script&gt;try{document.domain=#{JSON.stringify domain};}catch(e){}&lt;/script&gt;\n&quot;</span>
    
      <span class="nv">write: </span><span class="nf">(data) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>The data is passed to <code>m()</code>, which is bound to <em>onTridentRpcMessage_</em> in the client.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">res</span><span class="p">.</span><span class="nx">write</span> <span class="s2">&quot;&lt;script&gt;try {parent.m(#{JSON.stringify data})} catch(e) {}&lt;/script&gt;\n&quot;</span>
        <span class="nx">unless</span> <span class="nx">junkSent</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">write</span> <span class="nx">ieJunk</span>
          <span class="nv">junkSent = </span><span class="kc">true</span>

      <span class="nv">end: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Once the data has been received, the client needs to call <code>d()</code>, which is bound to
<em>onTridentDone_</em> with success=<em>true</em>.
The weird spacing of this is copied from browserchannel. Its really not necessary.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="s2">&quot;&lt;script&gt;try  {parent.d(); }catch (e){}&lt;/script&gt;\n&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>This is a helper method for signalling an error in the request back to the client.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">writeError: </span><span class="nf">(statusCode, message) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>The HTML (iframe) handler has no way to discover that the embedded script tag
didn't complete successfully. To signal errors, we return <strong>200 OK</strong> and call an
exposed rpcClose() method on the page.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">methods</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">()</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="s2">&quot;&lt;script&gt;try {parent.rpcClose(#{JSON.stringify message})} catch(e){}&lt;/script&gt;\n&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>For some reason, sending data during the second test (111112) works slightly differently for
XHR, but its identical for html encoding. We'll use a writeRaw() method in that case, which
is copied in the case of html.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">methods.writeRaw = </span><span class="nx">methods</span><span class="p">.</span><span class="nx">write</span>

    <span class="nx">methods</span>

  <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>For normal XHR requests, we send data normally.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">writeHead: </span><span class="o">-&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;OK&#39;</span><span class="p">,</span> <span class="nx">standardHeaders</span>
    <span class="nv">write: </span><span class="nf">(data) -&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">write</span> <span class="s2">&quot;#{data.length}\n#{data}&quot;</span>
    <span class="nv">writeRaw: </span><span class="nf">(data) -&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">write</span> <span class="nx">data</span>
    <span class="nv">end: </span><span class="o">-&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
    <span class="nv">writeError: </span><span class="nf">(statusCode, message) -&gt;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="nx">statusCode</span><span class="p">,</span> <span class="nx">standardHeaders</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="nx">message</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>For telling the client its done bad.</p>

<p>It turns out google's server isn't particularly fussy about signalling errors using the proper
html RPC stuff, so this is useful for html connections too.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">sendError = </span><span class="nf">(res, statusCode, message) -&gt;</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="nx">statusCode</span><span class="p">,</span> <span class="nx">message</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="s2">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;#{message}&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>
  <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <h2>Parsing client maps from the forward channel</h2>

<p>The client sends data in a series of url-encoded maps. The data is encoded like this:</p>

<p><code>
count=2&amp;ofs=0&amp;req0_x=3&amp;req0_y=10&amp;req1_abc=def
</code></p>

<p>First, we need to buffer up the request response and query string decode it.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">bufferPostData = </span><span class="nf">(req, callback) -&gt;</span>
  <span class="nv">data = </span><span class="p">[]</span>
  <span class="nx">req</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nf">(chunk) -&gt;</span>
    <span class="nx">data</span><span class="p">.</span><span class="nx">push</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">toString</span> <span class="s1">&#39;utf8&#39;</span>
  <span class="nx">req</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nv">data = </span><span class="nx">data</span><span class="p">.</span><span class="nx">join</span> <span class="s1">&#39;&#39;</span>
    <span class="nx">callback</span> <span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Next, we'll need to decode the incoming client data into an array of objects.</p>

<p>The data could be in two different forms:</p>

<ul>
<li>Classical browserchannel format, which is a bunch of string->string url-encoded maps</li>
<li>A JSON object</li>
</ul>

<p>We can tell what format the data is in by inspecting the content-type header</p>

<h2>URL Encoded data</h2>

<p>Essentially, url encoded the data looks like this:</p>

<p><code>
{ count: '2',
  ofs: '0',
  req0_x: '3',
  req0_y: '10',
  req1_abc: 'def'
}
</code></p>

<p>... and we will return an object in the form of <code>[{x:'3', y:'10'}, {abc: 'def'}, ...]</code></p>

<h2>JSON Encoded data</h2>

<p>JSON encoded the data looks like:</p>

<p><code>
{ ofs: 0
, data: [null, {...}, 1000.4, 'hi', ...]
}
</code></p>

<p>or <code>null</code> if there's no data.</p>

<p>This function returns null if there's no data or {ofs, json:[...]} or {ofs, maps:[...]}</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">decodeData = </span><span class="nf">(req, data) -&gt;</span>
  <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;application/json&#39;</span>
    <span class="nv">data = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">data</span>
    <span class="k">return</span> <span class="kc">null</span> <span class="k">if</span> <span class="nx">data</span> <span class="o">is</span> <span class="kc">null</span> <span class="c1"># There&#39;s no data. This is a valid response.</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>We'll restructure it slightly to mark the data as JSON rather than maps.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">{</span><span class="nx">ofs</span><span class="p">,</span> <span class="nx">data</span><span class="p">}</span> <span class="o">=</span> <span class="nx">data</span>
    <span class="p">{</span><span class="nx">ofs</span><span class="p">,</span> <span class="nx">json</span><span class="o">:</span><span class="nx">data</span><span class="p">}</span>
  <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Maps. Ugh.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">data = </span><span class="nx">querystring</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">data</span>
    <span class="nv">count = </span><span class="nb">parseInt</span> <span class="nx">data</span><span class="p">.</span><span class="nx">count</span>
    <span class="k">return</span> <span class="kc">null</span> <span class="k">if</span> <span class="nx">count</span> <span class="o">is</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>ofs will be missing if count is zero</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">ofs = </span><span class="nb">parseInt</span> <span class="nx">data</span><span class="p">.</span><span class="nx">ofs</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s1">&#39;invalid map data&#39;</span> <span class="k">if</span> <span class="nb">isNaN</span> <span class="nx">count</span> <span class="o">or</span> <span class="nb">isNaN</span> <span class="nx">ofs</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s1">&#39;Invalid maps&#39;</span> <span class="nx">unless</span> <span class="nx">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">or</span> <span class="p">(</span><span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">data</span><span class="p">.</span><span class="nx">ofs</span><span class="o">?</span><span class="p">)</span>

    <span class="nv">maps = </span><span class="k">new</span> <span class="nb">Array</span> <span class="nx">count</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Scan through all the keys in the data. Every key of the form:
<code>req123_xxx</code> will be used to populate its map.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">regex = </span><span class="sr">/^req(\d+)_(.+)$/</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span> <span class="k">of</span> <span class="nx">data</span>
      <span class="nv">match = </span><span class="nx">regex</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">key</span>
      <span class="k">if</span> <span class="nx">match</span>
        <span class="nv">id = </span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="nv">mapKey = </span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="nv">map = </span><span class="p">(</span><span class="nx">maps</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">||=</span> <span class="p">{})</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>The client uses <code>mapX_type=_badmap</code> to signify an error encoding a map.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">continue</span> <span class="k">if</span> <span class="nx">id</span> <span class="o">==</span> <span class="s1">&#39;type&#39;</span> <span class="o">and</span> <span class="nx">mapKey</span> <span class="o">==</span> <span class="s1">&#39;_badmap&#39;</span>
        <span class="nx">map</span><span class="p">[</span><span class="nx">mapKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span>

    <span class="p">{</span><span class="nx">ofs</span><span class="p">,</span> <span class="nx">maps</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>This is a helper method to order the handling of messages / requests / whatever.</p>

<p>Use it like this:
inOrder = order 0</p>

<p>inOrder 1, -> console.log 'second'
inOrder 0, -> console.log 'first'</p>

<p>Start is the ID of the first element we expect to receive. If we get data for earlier
elements, we'll play them anyway if playOld is truthy.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">order = </span><span class="nf">(start, playOld) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Base is the ID of the (missing) element at the start of the queue</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">base = </span><span class="nx">start</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>The queue will start with about 10 elements. Elements of the queue are undefined
if we don't have data for that queue element.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">queue = </span><span class="k">new</span> <span class="nb">Array</span> <span class="mi">10</span>

  <span class="nf">(seq, callback) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Its important that all the cells of the array are truthy if we have data. We'll use an
empty function instead of null.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">callback</span> <span class="o">or=</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Ignore old messages, or play them back immediately if playOld=true</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">seq</span> <span class="o">&lt;</span> <span class="nx">base</span>
      <span class="nx">callback</span><span class="p">()</span> <span class="k">if</span> <span class="nx">playOld</span>
    <span class="k">else</span>
      <span class="nx">queue</span><span class="p">[</span><span class="nx">seq</span> <span class="o">-</span> <span class="nx">base</span><span class="p">]</span> <span class="o">=</span> <span class="nx">callback</span>

      <span class="k">while</span> <span class="nx">queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nv">callback = </span><span class="nx">queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
        <span class="nx">base</span><span class="o">++</span>
        <span class="nx">callback</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>We need access to the client's sourcecode. I'm going to get it using a synchronous file call
(it'll be fast anyway, and only happen once).</p>

<p>I'm also going to set an etag on the client data so the browser client will be cached. I'm kind of
uncomfortable about adding complexity here because its not like this code hasn't been written
before, but.. I think a lot of people will use this API.</p>

<p>I should probably look into hosting the client code as a javascript module using that client-side
npm thing.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">clientFile = </span><span class="s2">&quot;#{__dirname}/../dist/bcsocket.js&quot;</span>
<span class="nv">clientStats = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span> <span class="nx">clientFile</span>
<span class="k">try</span>
  <span class="nv">clientCode = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span> <span class="nx">clientFile</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span>
<span class="k">catch</span> <span class="nx">e</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="s1">&#39;Could not load the client javascript. Run `cake client` to generate it.&#39;</span>
  <span class="k">throw</span> <span class="nx">e</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>This is mostly to help development, but if the client is recompiled, I'll pull in a new version.
This isn't tested by the unit tests - but its not a big deal.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">fs</span><span class="p">.</span><span class="nx">watchFile</span> <span class="nx">clientFile</span><span class="p">,</span> <span class="nv">persistent: </span><span class="kc">false</span><span class="p">,</span> <span class="nf">(curr, prev) -&gt;</span>
  <span class="k">if</span> <span class="nx">curr</span><span class="p">.</span><span class="nx">mtime</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">prev</span><span class="p">.</span><span class="nx">mtime</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Putting a synchronous file call here will stop the whole server while the client is reloaded.
Again, this will only happen during development so its not a big deal.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Reloading client JS&quot;</span>
    <span class="nv">clientCode = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span> <span class="nx">clientFile</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span>
    <span class="nv">clientStats = </span><span class="nx">curr</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <hr />

<h1>The server middleware</h1>

<p>The server module returns a function, which you can call with your configuration
options. It returns your configured connect middleware, which is actually another function.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">module.exports = browserChannel = </span><span class="nf">(options, onConnect) -&gt;</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">onConnect</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span>
    <span class="nv">onConnect = </span><span class="nx">options</span>
    <span class="nv">options = </span><span class="p">{}</span>

  <span class="nx">options</span> <span class="o">||=</span> <span class="p">{}</span>
  <span class="nx">options</span><span class="p">[</span><span class="nx">option</span><span class="p">]</span> <span class="o">?=</span> <span class="nx">value</span> <span class="k">for</span> <span class="nx">option</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">defaultOptions</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Strip off a trailing slash in base.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">base = </span><span class="nx">options</span><span class="p">.</span><span class="nx">base</span>
  <span class="nv">base = </span><span class="nx">base</span><span class="p">[...</span> <span class="nx">base</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nx">base</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/\/$/</span>
  </pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Add a leading slash back on base</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">base = </span><span class="s2">&quot;/#{base}&quot;</span> <span class="nx">unless</span> <span class="nx">base</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/^\//</span>

  <span class="nv">sessions = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Host prefixes provide a way to skirt around connection limits. They're only
really important for old browsers.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getHostPrefix = </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">hostPrefixes</span>
      <span class="nx">randomArrayElement</span> <span class="nx">options</span><span class="p">.</span><span class="nx">hostPrefixes</span>
    <span class="k">else</span>
      <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <h1>Create a new client session.</h1>

<p>This method will start a new client session.</p>

<p>Session ids are generated by <a href="https://github.com/substack/node-hat">node-hat</a>. They are guaranteed to be unique.
This method is synchronous, because a database will never be involved in browserchannel
session management. Browserchannel sessions only last as long as the user's browser
is open. If there's any connection turbulence, the client will reconnect and get
a new session id.</p>

<p>Sometimes a client will specify an old session ID and old array ID. In this case, the client
is reconnecting and we should evict the named session (if it exists).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">createSession = </span><span class="nf">(address, query, headers) -&gt;</span>
    <span class="p">{</span><span class="nx">RID</span><span class="o">:</span><span class="nx">initialRid</span><span class="p">,</span> <span class="nx">CVER</span><span class="o">:</span><span class="nx">appVersion</span><span class="p">,</span> <span class="nx">OSID</span><span class="o">:</span><span class="nx">oldSessionId</span><span class="p">,</span> <span class="nx">OAID</span><span class="o">:</span><span class="nx">oldArrayId</span><span class="p">}</span> <span class="o">=</span> <span class="nx">query</span>

    <span class="k">if</span> <span class="nx">oldSessionId</span><span class="o">?</span> <span class="o">and</span> <span class="p">(</span><span class="nv">oldSession = </span><span class="nx">sessions</span><span class="p">[</span><span class="nx">oldSessionId</span><span class="p">])</span>
      <span class="nx">oldSession</span><span class="p">.</span><span class="nx">_acknowledgeArrays</span> <span class="nx">oldArrayId</span>
      <span class="nx">oldSession</span><span class="p">.</span><span class="nx">close</span> <span class="s1">&#39;Reconnected&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Create a new session. Sessions extend node's <a href="http://nodejs.org/docs/v0.4.12/api/events.html">EventEmitter</a> so they have access to
goodies like <code>session.on(event, handler)</code>, <code>session.emit('paarty')</code>, etc.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">session = </span><span class="k">new</span> <span class="nx">EventEmitter</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>The session's unique ID for this connection</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">session.id = </span><span class="nx">hat</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>The client stores its IP address and headers from when it first opened the session. The
handler can use this information for authentication or something.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">session.address = </span><span class="nx">address</span>
    <span class="nv">session.headers = </span><span class="nx">headers</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>The session is a little state machine. It has the following states:</p>

<ul>
<li><p><strong>init</strong>: The session has been created and its sessionId hasn't been sent yet.
The session moves to the <strong>ok</strong> state when the first data chunk is sent to the
client.</p></li>
<li><p><strong>ok</strong>: The session is sitting pretty and ready to send and receive data.
The session will spend most of its time in this state.</p></li>
<li><p><strong>closed</strong>: The session has been removed from the session list. It can no longer
be used for any reason.</p>

<p>It is invalid to send arrays to a session while it is closed. Unless you're
Bruce Willis...</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">session.state = </span><span class="s1">&#39;init&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>The state is modified through this method. It emits events when the state changes.
(yay)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">changeState = </span><span class="nf">(newState) -&gt;</span>
      <span class="nv">oldState = </span><span class="nx">session</span><span class="p">.</span><span class="nx">state</span>
      <span class="nv">session.state = </span><span class="nx">newState</span>
      <span class="nx">session</span><span class="p">.</span><span class="nx">emit</span> <span class="s1">&#39;state changed&#39;</span><span class="p">,</span> <span class="nx">session</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">oldState</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>The server sends messages to the client via a hanging GET request. Of course,
the client has to be the one to open that request.</p>

<p>This is a handle to null, or {res, methods, chunk}</p>

<ul>
<li><strong>res</strong> is the http response object</li>
<li><strong>methods</strong> is a map of send(), etc methods for communicating properly with the backchannel -
this will be different if the request comes from IE or not.</li>
<li><strong>chunk</strong> specifies whether or not we're going to keep the connection open across multiple
messages. If there's a buffering proxy in the way of the connection, we can't respond a bit at
a time, so we close the backchannel after each data chunk. The client decides this during
testing and passes a CI= parameter to the server when the backchannel connection is established.</li>
<li><strong>bytesSent</strong> specifies how many bytes of data have been sent through the backchannel. We periodically
close the backchannel and let the client reopen it, so things like the chrome web inspector stay
usable.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">backChannel = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>The server sends data to the client by sending <em>arrays</em>. It seems a bit silly that
client->server messages are maps and server->client messages are arrays, but there it is.</p>

<p>Each entry in this array is of the form [id, data].</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">outgoingArrays = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p><code>lastArrayId</code> is the array ID of the last queued array</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">lastArrayId = </span><span class="o">-</span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Every request from the client has an <em>AID</em> parameter which tells the server the ID
of the last request the client has received. We won't remove arrays from the outgoingArrays
list until the client has confirmed its received them.</p>

<p>In <code>lastSentArrayId</code> we store the ID of the last array which we actually sent.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">lastSentArrayId = </span><span class="o">-</span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>I would like this method to be private or something, but it needs to be accessed from
the HTTP request code below. The _ at the start will hopefully make people think twice
before using it.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">session._setBackChannel = </span><span class="nf">(res, query) -&gt;</span>
      <span class="nx">clearBackChannel</span><span class="p">()</span>

      <span class="nv">backChannel =</span>
        <span class="nv">res: </span><span class="nx">res</span>
        <span class="nv">methods: </span><span class="nx">messagingMethods</span> <span class="nx">query</span><span class="p">,</span> <span class="nx">res</span>
        <span class="nv">chunk: </span><span class="nx">query</span><span class="p">.</span><span class="nx">CI</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span>
        <span class="nv">bytesSent: </span><span class="mi">0</span>

      <span class="nx">res</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">once</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">clearBackChannel</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>We'll start the heartbeat interval and clear out the session timeout.
The session timeout will be started again if the backchannel connection closes for
any reason.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">refreshHeartbeat</span><span class="p">()</span>
      <span class="nx">clearTimeout</span> <span class="nx">sessionTimeout</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>When a new backchannel is created, its possible that the old backchannel is dead.
In this case, its possible that previously sent arrays haven't been received.
By resetting lastSentArrayId, we're effectively rolling back the status of sent arrays
to only those arrays which have been acknowledged.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">lastSentArrayId = </span><span class="nx">outgoingArrays</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">id</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="nx">outgoingArrays</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Send any arrays we've buffered now that we have a backchannel</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@flush</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>If we haven't sent anything for 15 seconds, we'll send a little <code>['noop']</code> to the
client so it knows we haven't forgotten it. (And to make sure the backchannel
connection doesn't time out.)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">heartbeat = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>This method removes the back channel and any state associated with it. It'll get called
when the backchannel closes naturally, is replaced or when the connection closes.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">clearBackChannel = </span><span class="nf">(res) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>clearBackChannel doesn't do anything if we call it repeatedly.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="nx">unless</span> <span class="nx">backChannel</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Its important that we only delete the backchannel if the closed connection is actually
the backchannel we're currently using.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="k">if</span> <span class="nx">res</span><span class="o">?</span> <span class="o">and</span> <span class="nx">res</span> <span class="o">!=</span> <span class="nx">backChannel</span><span class="p">.</span><span class="nx">res</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Conveniently, clearTimeout has no effect if the argument is null.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">clearTimeout</span> <span class="nx">heartbeat</span>

      <span class="nx">backChannel</span><span class="p">.</span><span class="nx">methods</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
      <span class="nv">backChannel = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Whenever we don't have a backchannel, we run the session timeout timer.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">refreshSessionTimeout</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>This method sets / resets the heartbeat timeout to the full 15 seconds.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">refreshHeartbeat = </span><span class="o">-&gt;</span>
      <span class="nx">clearTimeout</span> <span class="nx">heartbeat</span>

      <span class="nv">heartbeat = </span><span class="nx">setInterval</span> <span class="p">(</span><span class="o">-&gt;</span> <span class="nx">session</span><span class="p">.</span><span class="nx">send</span> <span class="p">[</span><span class="s1">&#39;noop&#39;</span><span class="p">]),</span> <span class="nx">options</span><span class="p">.</span><span class="nx">keepAliveInterval</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>The session will close if there's been no backchannel for awhile.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">sessionTimeout = </span><span class="kc">null</span>

    <span class="nv">refreshSessionTimeout = </span><span class="o">-&gt;</span>
      <span class="nx">clearTimeout</span> <span class="nx">sessionTimeout</span>
      <span class="nv">sessionTimeout = </span><span class="nx">setTimeout</span> <span class="p">(</span><span class="o">-&gt;</span> <span class="nx">session</span><span class="p">.</span><span class="nx">close</span> <span class="s1">&#39;Timed out&#39;</span><span class="p">),</span> <span class="nx">options</span><span class="p">.</span><span class="nx">sessionTimeoutInterval</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Since the session doesn't start with a backchannel, we'll kick off the timeout timer as soon as its
created.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">refreshSessionTimeout</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>The arrays get removed once they've been acknowledged</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">session._acknowledgeArrays = </span><span class="nf">(id) -&gt;</span>
      <span class="nv">id = </span><span class="nb">parseInt</span> <span class="nx">id</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">id</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>

      <span class="k">while</span> <span class="nx">outgoingArrays</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">outgoingArrays</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">id</span> <span class="o">&lt;=</span> <span class="nx">id</span>
        <span class="p">{</span><span class="nx">confirmcallback</span><span class="p">}</span> <span class="o">=</span> <span class="nx">outgoingArrays</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>I've got no idea what to do if we get an exception thrown here. The session will end up
in an inconsistant state...</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">confirmcallback</span><span class="o">?</span><span class="p">()</span>

      <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Queue an array to be sent. The optional callbacks notifies a caller when the array has been
sent, and then received by the client.</p>

<p>queueArray returns the ID of the queued data chunk.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">queueArray = </span><span class="nf">(data, sendcallback, confirmcallback) -&gt;</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;Cannot queue array when the session is already closed&quot;</span> <span class="k">if</span> <span class="nx">session</span><span class="p">.</span><span class="nx">state</span> <span class="o">==</span> <span class="s1">&#39;closed&#39;</span>

      <span class="nv">id = </span><span class="o">++</span><span class="nx">lastArrayId</span>
      <span class="nx">outgoingArrays</span><span class="p">.</span><span class="nx">push</span> <span class="p">{</span><span class="nx">id</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">sendcallback</span><span class="p">,</span> <span class="nx">confirmcallback</span><span class="p">}</span>

      <span class="nx">lastArrayId</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>The session has just been created. The first thing it needs to tell the client
is its session id and host prefix and stuff.</p>

<p>It would be pretty easy to add a callback here setting the client status to 'ok' or
something, but its not really necessary. The client has already connected once the first
POST /bind has been received.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">queueArray</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">session</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">getHostPrefix</span><span class="p">(),</span> <span class="mi">8</span><span class="p">]</span>
        </pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>Send the array data through the backchannel. This takes an optional callback which
will be called with no arguments when the client acknowledges the array, or called with an
error object if the client disconnects before the array is sent.</p>

<p>queueArray can also take a callback argument which is called when the session sends the message
in the first place. I'm not sure if I should expose this through send - I can't tell if its
useful beyond the server code.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">session.send = </span><span class="nf">(arr, callback) -&gt;</span>
      <span class="nv">id = </span><span class="nx">queueArray</span> <span class="nx">arr</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">callback</span>
      <span class="nx">@flush</span><span class="p">()</span>
      <span class="nx">id</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <h3>Maps</h3>

<p>The client sends maps to the server using POST requests. Its possible for the requests
to come in out of order, so sometimes we need to buffer up incoming maps and reorder them
before emitting them to the user.</p>

<p>Each map has an ID (which starts at 0 when the session is first created). </p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>We'll emit received data to the user immediately if they're in order, but if they're out of order
we'll use the little order helper above to order them. The order helper is instructed to not
emit any old messages twice.</p>

<p>There's a potential DOS attack here whereby a client could just spam the server with
out-of-order maps until it runs out of memory. We should dump a session if there are
too many entries in this dictionary.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">mapBuffer = </span><span class="nx">order</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>This method is called whenever we get maps from the client. Offset is the ID of the first
map. The data could either be maps or JSON data. If its maps, data contains {maps} and if its
JSON data, maps contains {JSON}.</p>

<p>Browserchannel has 2 different mechanisms for consistantly ordering messages in the forward channel:</p>

<ul>
<li><p>Each forward channel request contains a request ID (RID=X), which start at a random value
(set with the first session create packet). These increment by 1 with each request.</p>

<p>If a request fails, it might be retried with the same RID as the previous message, and with extra
maps tacked on the end. We need to handle the maps in this case.</p></li>
<li><p>Each map has an ID, counting from 0. ofs= in the POST data tells the server the ID of the first
map in a request.</p></li>
</ul>

<p>As far as I can tell, the RID stuff can mostly be ignored. The one place it is important is in
handling disconnect messages. The session should only be disconnected by a disconnect message when
the preceeding messages have been received.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>All requests are handled in order too, though if not for disconnecting I don't think it would matter.
Because of the funky retry-has-extra-maps logic, we'll allow processing requests twice.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">ridBuffer = </span><span class="nx">order</span> <span class="nx">initialRid</span><span class="p">,</span> <span class="kc">true</span>

    <span class="nv">session._receivedData = </span><span class="nf">(rid, data) -&gt;</span>
      <span class="nx">ridBuffer</span> <span class="nx">rid</span><span class="p">,</span> <span class="o">-&gt;</span>
        <span class="k">return</span> <span class="k">if</span> <span class="nx">data</span> <span class="o">is</span> <span class="kc">null</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s1">&#39;Invalid data&#39;</span> <span class="nx">unless</span> <span class="nx">data</span><span class="p">.</span><span class="nx">maps</span><span class="o">?</span> <span class="o">or</span> <span class="nx">data</span><span class="p">.</span><span class="nx">json</span><span class="o">?</span>

        <span class="nx">ridBuffer</span> <span class="nx">rid</span>
        <span class="nv">id = </span><span class="nx">data</span><span class="p">.</span><span class="nx">ofs</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>First, classic browserchannel maps.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">maps</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>If an exception is thrown during this loop, I'm not really sure what the behaviour should be.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">for</span> <span class="nx">map</span> <span class="k">in</span> <span class="nx">data</span><span class="p">.</span><span class="nx">maps</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>The funky do expression here is used to pass the map into the closure.
Another way to do it is to index into the data.maps array inside the function, but then I'd
need to pass the index to the closure anyway.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">mapBuffer</span> <span class="nx">id</span><span class="o">++</span><span class="p">,</span> <span class="nx">do</span> <span class="nf">(map) -&gt;</span> <span class="o">-&gt;</span>
              <span class="k">return</span> <span class="k">if</span> <span class="nx">session</span><span class="p">.</span><span class="nx">state</span> <span class="o">is</span> <span class="s1">&#39;closed&#39;</span>

              <span class="nx">session</span><span class="p">.</span><span class="nx">emit</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="nx">map</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>If you specify the key as JSON, the server will try to decode JSON data from the map and emit
'message'. This is a much nicer way to message the server.</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="k">if</span> <span class="nx">map</span><span class="p">.</span><span class="nx">JSON</span><span class="o">?</span>
                <span class="k">try</span>
                  <span class="nv">message = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">map</span><span class="p">.</span><span class="nx">JSON</span>
                  <span class="nx">session</span><span class="p">.</span><span class="nx">emit</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nx">message</span>
        <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>We have data.json. We'll just emit it directly.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">for</span> <span class="nx">message</span> <span class="k">in</span> <span class="nx">data</span><span class="p">.</span><span class="nx">json</span>
            <span class="nx">mapBuffer</span> <span class="nx">id</span><span class="o">++</span><span class="p">,</span> <span class="nx">do</span> <span class="nf">(map) -&gt;</span> <span class="o">-&gt;</span>
              <span class="k">return</span> <span class="k">if</span> <span class="nx">session</span><span class="p">.</span><span class="nx">state</span> <span class="o">is</span> <span class="s1">&#39;closed&#39;</span>
              <span class="nx">session</span><span class="p">.</span><span class="nx">emit</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nx">message</span>

    <span class="nv">session._disconnectAt = </span><span class="nf">(rid) -&gt;</span>
      <span class="nx">ridBuffer</span> <span class="nx">rid</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">session</span><span class="p">.</span><span class="nx">close</span> <span class="s1">&#39;Disconnected&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>When we receive forwardchannel data, we reply with a special little 3-variable array to tell the
client if it should reopen the backchannel.</p>

<p>This method returns what the forward channel should reply with.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">session._backChannelStatus = </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Find the arrays have been sent over the wire but haven't been acknowledged yet</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">numUnsentArrays = </span><span class="nx">lastArrayId</span> <span class="o">-</span> <span class="nx">lastSentArrayId</span>
      <span class="nv">unacknowledgedArrays = </span><span class="nx">outgoingArrays</span><span class="p">[...</span> <span class="nx">outgoingArrays</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">numUnsentArrays</span><span class="p">]</span>
      <span class="nv">outstandingBytes = </span><span class="k">if</span> <span class="nx">unacknowledgedArrays</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="mi">0</span>
      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>We don't care about the length of the array IDs or callback functions.
I'm actually not sure what data the client expects here - the value is just used in a rough
heuristic to determine if the backchannel should be reopened.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">data = </span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">data</span> <span class="k">for</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">unacknowledgedArrays</span><span class="p">)</span>
        <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">).</span><span class="nx">length</span>

      <span class="p">[</span>
        <span class="p">(</span><span class="k">if</span> <span class="nx">backChannel</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="nx">lastSentArrayId</span>
        <span class="nx">outstandingBytes</span>
      <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <h2>Encoding server arrays for the back channel</h2>

<p>The server sends data to the client in <strong>chunks</strong>. Each chunk is a <em>JSON</em> array prefixed
by its length in bytes.</p>

<p>The array looks like this:</p>

<p><code>
[
  [100, ['message', 'one']],
  [101, ['message', 'two']],
  [102, ['message', 'three']]
]
</code></p>

<p>Each individial message is prefixed by its <em>array id</em>, which is a counter starting at 0
when the session is first created and incremented with each array.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>This will actually send the arrays to the backchannel on the next tick if the backchannel
is alive.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">session.flush = </span><span class="o">-&gt;</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="nx">backChannel</span>
          <span class="nv">numUnsentArrays = </span><span class="nx">lastArrayId</span> <span class="o">-</span> <span class="nx">lastSentArrayId</span>
          <span class="k">if</span> <span class="nx">numUnsentArrays</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="nv">arrays = </span><span class="nx">outgoingArrays</span><span class="p">[</span><span class="nx">outgoingArrays</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">numUnsentArrays</span> <span class="p">...]</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>I've abused outgoingArrays to also contain some callbacks. We only send [id, data] to
the client.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">data = </span><span class="p">([</span><span class="nx">id</span><span class="p">,</span> <span class="nx">data</span><span class="p">]</span> <span class="k">for</span> <span class="p">{</span><span class="nx">id</span><span class="p">,</span> <span class="nx">data</span><span class="p">}</span> <span class="k">in</span> <span class="nx">arrays</span><span class="p">)</span>
            <span class="nv">bytes = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\n&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p><strong>Away!</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">backChannel</span><span class="p">.</span><span class="nx">methods</span><span class="p">.</span><span class="nx">write</span> <span class="nx">bytes</span>
            <span class="nx">backChannel</span><span class="p">.</span><span class="nx">bytesSent</span> <span class="o">+=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">length</span>

            <span class="nv">lastSentArrayId = </span><span class="nx">lastArrayId</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>Fire any send callbacks on the messages. These callbacks should only be called once.
Again, not sure what to do if there are exceptions here.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">for</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">arrays</span>
              <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">sendcallback</span><span class="o">?</span>
                <span class="nx">a</span><span class="p">.</span><span class="nx">sendcallback</span><span class="o">?</span><span class="p">()</span>
                <span class="k">delete</span> <span class="nx">a</span><span class="p">.</span><span class="nx">sendcallback</span>

            <span class="k">if</span> <span class="o">!</span><span class="nx">backChannel</span><span class="p">.</span><span class="nx">chunk</span> <span class="o">or</span> <span class="nx">backChannel</span><span class="p">.</span><span class="nx">bytesSent</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span>
              <span class="nx">clearBackChannel</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>The first backchannel is the client's initial connection. Once we've sent the first
data chunk to the client, we've officially opened the connection.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">changeState</span> <span class="s1">&#39;ok&#39;</span> <span class="k">if</span> <span class="nx">session</span><span class="p">.</span><span class="nx">state</span> <span class="o">==</span> <span class="s1">&#39;init&#39;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>The client's reported application version, or null. This is sent when the
connection is first requested, so you can use it to make your application die / stay
compatible with people who don't close their browsers.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">session.appVersion = </span><span class="nx">appVersion</span> <span class="o">or</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>Signal to a client that it should stop trying to connect. This has no other effect
on the server session.</p>

<p><code>stop</code> takes a callback which will be called once the message has been <em>sent</em> by the server.
Typically, you should call it like this:</p>

<p><code>
session.stop -&gt;
  session.close()
</code></p>

<p>I considered making this automatically close the connection after you've called it, or after
you've sent the stop message or something, but if I did that it wouldn't be obvious that you
can still receive messages after stop() has been called. (Because you can!). That would never
come up when you're testing locally, but it <em>would</em> come up in production. This is more obvious.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">session.stop = </span><span class="nf">(callback) -&gt;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">@state</span> <span class="o">is</span> <span class="s1">&#39;closed&#39;</span>
      <span class="nx">queueArray</span> <span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">],</span> <span class="nx">callback</span><span class="p">,</span> <span class="kc">null</span>
      <span class="nx">@flush</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>This closes a session and makes the server forget about it.</p>

<p>The client might try and reconnect if you only call <code>close()</code>. It'll get a new session if it does so.</p>

<p>close takes an optional message argument, which is passed to the send event handlers.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">session.close = </span><span class="nf">(message) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>You can't double-close.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="k">if</span> <span class="nx">@state</span> <span class="o">==</span> <span class="s1">&#39;closed&#39;</span>

      <span class="nx">changeState</span> <span class="s1">&#39;closed&#39;</span>
      <span class="nx">@emit</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="nx">message</span>

      <span class="nx">clearBackChannel</span><span class="p">()</span>
      <span class="nx">clearTimeout</span> <span class="nx">sessionTimeout</span>

      <span class="k">for</span> <span class="p">{</span><span class="nx">confirmcallback</span><span class="p">}</span> <span class="k">in</span> <span class="nx">outgoingArrays</span>
        <span class="nx">confirmcallback</span><span class="o">?</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span> <span class="nx">message</span> <span class="o">||</span> <span class="s1">&#39;closed&#39;</span><span class="p">)</span>
      
      <span class="k">delete</span> <span class="nx">sessions</span><span class="p">[</span><span class="nx">@id</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>console.log "closed #{@id}"</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">sessions</span><span class="p">[</span><span class="nx">session</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">session</span>

    <span class="nx">session</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>This is the returned middleware. Connect middleware is a function which
takes in an http request, an http response and a next method.</p>

<p>The middleware can do one of two things:</p>

<ul>
<li>Handle the request, sending data back to the server via the response</li>
<li>Call <code>next()</code>, which allows the next middleware in the stack a chance to
handle the request.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nf">(req, res, next) -&gt;</span>
    <span class="p">{</span><span class="nx">query</span><span class="p">,</span> <span class="nx">pathname</span><span class="p">}</span> <span class="o">=</span> <span class="nx">parse</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>console.warn req.method, req.url</p>             </td>             <td class="code">               <div class="highlight"><pre>    </pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>If base is /foo, we don't match /foobar. (Currently no unit tests for this)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">next</span><span class="p">()</span> <span class="k">if</span> <span class="nx">pathname</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">base</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;#{base}/&quot;</span>

    <span class="p">{</span><span class="nx">writeHead</span><span class="p">,</span> <span class="nx">write</span><span class="p">,</span> <span class="nx">writeRaw</span><span class="p">,</span> <span class="nx">end</span><span class="p">,</span> <span class="nx">writeError</span><span class="p">}</span> <span class="o">=</span> <span class="nx">messagingMethods</span> <span class="nx">query</span><span class="p">,</span> <span class="nx">res</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <h1>Serving the client</h1>

<p>The browserchannel server hosts a usable web client library at /CHANNEL/bcsocket.js.
This library wraps the google closure library client implementation.</p>

<p>If I have time, I would like to write my own version of the client to add a few features
(websockets, message acknowledgement callbacks) and do some manual optimisations for speed.
However, the current version works ok.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">pathname</span> <span class="o">is</span> <span class="s2">&quot;#{base}/bcsocket.js&quot;</span>
      <span class="nv">etag = </span><span class="s2">&quot;\&quot;#{clientStats.size}-#{clientStats.mtime.getTime()}\&quot;&quot;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;OK&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/javascript&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ETag&#39;</span><span class="o">:</span> <span class="nx">etag</span><span class="p">,</span>
        <span class="s1">&#39;Content-Length&#39;</span><span class="o">:</span> <span class="nx">clientCode</span><span class="p">.</span><span class="nx">length</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>This code is manually tested because it looks like its impossible to send HEAD requests
using nodejs's HTTP library at time of writing (0.4.12). (Yeah, I know, rite?)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">is</span> <span class="s1">&#39;HEAD&#39;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
      <span class="k">else</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="nx">clientCode</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <h1>Connection testing</h1>

<p>Before the browserchannel client connects, it tests the connection to make
sure its working, and to look for buffering proxies.</p>

<p>The server-side code for connection testing is completely stateless.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span> <span class="nx">pathname</span> <span class="o">is</span> <span class="s2">&quot;#{base}/test&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>This server only supports browserchannel protocol version <strong>8</strong>.
I have no idea if 400 is the right error here.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="nx">sendError</span> <span class="nx">res</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="s1">&#39;Version 8 required&#39;</span> <span class="nx">unless</span> <span class="nx">query</span><span class="p">.</span><span class="nx">VER</span> <span class="o">is</span> <span class="s1">&#39;8&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <h3>Phase 1: Server info</h3>

<p>The client is requests host prefixes. The server responds with an array of
['hostprefix' or null, 'blockedprefix' or null].</p>

<blockquote>
  <p>Actually, I think you might be able to return [] if neither hostPrefix nor blockedPrefix
  is defined. (Thats what google wave seems to do)</p>
</blockquote>

<ul>
<li><p><strong>hostprefix</strong> is subdomain prepended onto the hostname of each request.
This gets around browser connection limits. Using this requires a bank of
configured DNS entries and SSL certificates if you're using HTTPS.</p></li>
<li><p><strong>blockedprefix</strong> provides network admins a way to blacklist browserchannel
requests. It is not supported by node-browserchannel.</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">query</span><span class="p">.</span><span class="nx">MODE</span> <span class="o">==</span> <span class="s1">&#39;init&#39;</span> <span class="o">and</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span>
        <span class="nv">hostPrefix = </span><span class="nx">getHostPrefix</span><span class="p">()</span>
        <span class="nv">blockedPrefix = </span><span class="kc">null</span> <span class="c1"># Blocked prefixes aren&#39;t supported.</span></pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>We add an extra special header to tell the client that this server likes
json-encoded forward channel data over form urlencoded channel data.</p>

<p>It might be easier to put these headers in the response body or increment the
version, but that might conflict with future browserchannel versions.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">headers = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">create</span> <span class="nx">standardHeaders</span>
        <span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;X-Accept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;application/json; application/x-www-form-urlencoded&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>This is a straight-up normal HTTP request like the forward channel requests.
We don't use the funny iframe write methods.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;OK&#39;</span><span class="p">,</span> <span class="nx">headers</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="p">[</span><span class="nx">hostPrefix</span><span class="p">,</span> <span class="nx">blockedPrefix</span><span class="p">])</span>

      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <h3>Phase 2: Buffering proxy detection</h3>

<p>The client is trying to determine if their connection is buffered or unbuffered.
We reply with '11111', then 2 seconds later '2'.</p>

<p>The client should get the data in 2 chunks - but they won't if there's a misbehaving
corporate proxy in the way or something.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">writeHead</span><span class="p">()</span>
        <span class="nx">writeRaw</span> <span class="s1">&#39;11111&#39;</span>
        <span class="nx">setTimeout</span> <span class="p">(</span><span class="o">-&gt;</span> <span class="nx">writeRaw</span> <span class="s1">&#39;2&#39;</span><span class="p">;</span> <span class="nx">end</span><span class="p">()),</span> <span class="mi">2000</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <h1>BrowserChannel connection</h1>

<p>Once a client has finished testing its connection, it connects.</p>

<p>BrowserChannel communicates through two connections:</p>

<ul>
<li>The <strong>forward channel</strong> is used for the client to send data to the server.
It uses a <strong>POST</strong> request for each message.</li>
<li>The <strong>back channel</strong> is used to get data back from the server. This uses a
hanging <strong>GET</strong> request. If chunking is disallowed (ie, if the proxy buffers)
then the back channel is closed after each server message.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span> <span class="nx">pathname</span> <span class="o">==</span> <span class="s2">&quot;#{base}/bind&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>I'm copying the behaviour of unknown SIDs below. I don't know how the client
is supposed to detect this error, but, eh. The other choice is to <code>return writeError ...</code></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="nx">sendError</span> <span class="nx">res</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="s1">&#39;Version 8 required&#39;</span> <span class="nx">unless</span> <span class="nx">query</span><span class="p">.</span><span class="nx">VER</span> <span class="o">is</span> <span class="s1">&#39;8&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>All browserchannel connections have an associated client object. A client
is created immediately if the connection is new.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">query</span><span class="p">.</span><span class="nx">SID</span>
        <span class="nv">session = </span><span class="nx">sessions</span><span class="p">[</span><span class="nx">query</span><span class="p">.</span><span class="nx">SID</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <p>This is a special error code for the client. It tells the client to abandon its
connection request and reconnect.</p>

<p>For some reason, google replies with the same response on HTTP and HTML requests here.
I'll follow suit, though its a little weird. Maybe I should do the same with all client
errors?</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="nx">sendError</span> <span class="nx">res</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="s1">&#39;Unknown SID&#39;</span> <span class="nx">unless</span> <span class="nx">session</span>

      <span class="nx">session</span><span class="p">.</span><span class="nx">_acknowledgeArrays</span> <span class="nx">query</span><span class="p">.</span><span class="nx">AID</span> <span class="k">if</span> <span class="nx">query</span><span class="p">.</span><span class="nx">AID</span><span class="o">?</span> <span class="o">and</span> <span class="nx">session</span></pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <h3>Forward Channel</h3>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span>
        <span class="k">if</span> <span class="nx">session</span> <span class="o">==</span> <span class="kc">undefined</span>
          </pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <p>The session is new! Make them a new session object and let the
application know.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">session = </span><span class="nx">createSession</span> <span class="nx">req</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">remoteAddress</span><span class="p">,</span> <span class="nx">query</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span>
          <span class="nx">onConnect</span><span class="o">?</span> <span class="nx">session</span>

        <span class="nx">bufferPostData</span> <span class="nx">req</span><span class="p">,</span> <span class="nf">(data) -&gt;</span>
          <span class="k">try</span>
            <span class="nv">data = </span><span class="nx">decodeData</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">data</span>
            <span class="nx">session</span><span class="p">.</span><span class="nx">_receivedData</span> <span class="nx">query</span><span class="p">.</span><span class="nx">RID</span><span class="p">,</span> <span class="nx">data</span>
          <span class="k">catch</span> <span class="nx">e</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span> <span class="s1">&#39;Error parsing forward channel&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">stack</span>
            <span class="k">return</span> <span class="nx">sendError</span> <span class="nx">res</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="s1">&#39;Bad data&#39;</span>

          <span class="k">if</span> <span class="nx">session</span><span class="p">.</span><span class="nx">state</span> <span class="o">is</span> <span class="s1">&#39;init&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <p>The initial forward channel request is also used as a backchannel for the server's
initial data (session id, etc). This connection is a little bit special - it is always
encoded using length-prefixed json encoding and it is closed as soon as the first chunk is
sent.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;OK&#39;</span><span class="p">,</span> <span class="nx">standardHeaders</span>
            <span class="nx">session</span><span class="p">.</span><span class="nx">_setBackChannel</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">CI</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">TYPE</span><span class="o">:</span><span class="s1">&#39;xmlhttp&#39;</span><span class="p">,</span> <span class="nx">RID</span><span class="o">:</span><span class="s1">&#39;rpc&#39;</span>
            <span class="nx">session</span><span class="p">.</span><span class="nx">flush</span><span class="p">()</span>
          <span class="k">else</span> <span class="k">if</span> <span class="nx">session</span><span class="p">.</span><span class="nx">state</span> <span class="o">is</span> <span class="s1">&#39;closed&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <p>If the onConnect handler called close() immediately, session.state can be already closed at this point.
I'll assume there was an authentication problem and treat this as a forbidden connection attempt.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">sendError</span> <span class="nx">res</span><span class="p">,</span> <span class="mi">403</span><span class="p">,</span> <span class="s1">&#39;Forbidden&#39;</span>
          <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <p>On normal forward channels, we reply to the request by telling the session
if our backchannel is still live and telling it how many unconfirmed
arrays we have.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">response = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">session</span><span class="p">.</span><span class="nx">_backChannelStatus</span><span class="p">()</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;OK&#39;</span><span class="p">,</span> <span class="nx">standardHeaders</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="s2">&quot;#{response.length}\n#{response}&quot;</span>

      <span class="k">else</span> <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">is</span> <span class="s1">&#39;GET&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <h3>Back channel</h3>

<p>GET messages are usually backchannel requests (server->client). Backchannel messages are handled
by the session object.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">query</span><span class="p">.</span><span class="nx">TYPE</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;xmlhttp&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">]</span>
          <span class="k">return</span> <span class="nx">sendError</span> <span class="nx">res</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="s1">&#39;Invalid SID&#39;</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">query</span><span class="p">.</span><span class="nx">SID</span> <span class="o">!=</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">query</span><span class="p">.</span><span class="nx">SID</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">5</span>
          <span class="k">return</span> <span class="nx">sendError</span> <span class="nx">res</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="s1">&#39;Expected RPC&#39;</span> <span class="nx">unless</span> <span class="nx">query</span><span class="p">.</span><span class="nx">RID</span> <span class="o">is</span> <span class="s1">&#39;rpc&#39;</span>
          <span class="nx">writeHead</span><span class="p">()</span>
          <span class="nx">session</span><span class="p">.</span><span class="nx">_setBackChannel</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">query</span></pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p>The client can manually disconnect by making a GET request with TYPE='terminate'</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">else</span> <span class="k">if</span> <span class="nx">query</span><span class="p">.</span><span class="nx">TYPE</span> <span class="o">is</span> <span class="s1">&#39;terminate&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <p>We don't send any data in the response to the disconnect message.</p>

<p>The client implements this using an img= appended to the page.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">session</span><span class="o">?</span><span class="p">.</span><span class="nx">_disconnectAt</span> <span class="nx">query</span><span class="p">.</span><span class="nx">RID</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;OK&#39;</span><span class="p">,</span> <span class="nx">standardHeaders</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>

      <span class="k">else</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">405</span><span class="p">,</span> <span class="s1">&#39;Method Not Allowed&#39;</span><span class="p">,</span> <span class="nx">standardHeaders</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="s2">&quot;Method not allowed&quot;</span>
        

    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <p>We'll 404 the user instead of letting another handler take care of it.
Users shouldn't be using the specified URL prefix for anything else.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">404</span><span class="p">,</span> <span class="s1">&#39;Not Found&#39;</span><span class="p">,</span> <span class="nx">standardHeaders</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="s2">&quot;Not found&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <p>This will override the timer methods (<code>setInterval</code>, etc) with the testing stub versions,
which are way faster.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">browserChannel._setTimerMethods = </span><span class="nf">(methods) -&gt;</span>
  <span class="p">{</span><span class="nx">setInterval</span><span class="p">,</span> <span class="nx">clearInterval</span><span class="p">,</span> <span class="nx">setTimeout</span><span class="p">,</span> <span class="nx">clearTimeout</span><span class="p">,</span> <span class="nb">Date</span><span class="p">}</span> <span class="o">=</span> <span class="nx">methods</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 